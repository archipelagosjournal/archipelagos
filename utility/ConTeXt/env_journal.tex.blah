\startenvironment env_journal
\enableregime[utf]  
\setupcolors[state=start]
\setupreferencing[autofile=yes]
\setupinteraction[state=start, color=black, contrastcolor=black, style={\ss}]
\placebookmarks[chapter,subsection, subsubsection][chapter,subsection, subsubsection]



\definefontfeature
  [default]
  [default]
  [protrusion=quality,expansion=quality]

%\definefontfamily [roboto][sans][Roboto]

%\usemodule[simplefonts]
%\setmainfont[xits][expansion=quality,protrusion=quality]
% \definefallbackfamily[main]
%                  [sans]
%                  [Open Sans Emoji]
%                  [range=0x1F000-0x1FFFF]
%                  %[range={0x1F48B}]
%                  %[range={miscellaneoussymbols,emotion, dingbats}]

% \definefallbackfamily[main]
%                  [sans]
%                  [Noto Sans]
%                  [range=0x00000-0xFFFFF]

%                  %[range=0x1F000-0x1FFFF]

% \definefontfamily[main]
%                  [sans]
%                  [Helvetica Neue]
%                  [tf=file:helveticaneue, 
%                   it=file:helveticaneueitalic, 
%                   sl=file:helveticaneueitalic,
%                   expansion=quality,
%                   protrusion=quality]
% \definefontfamily[light]
%                  [sans]
%                  [Helvetica Neue]
%                  [tf=file:helveticaneuelight, 
%                   it=file:helveticaneuelightitalic, 
%                   sl=file:helveticaneuelightitalic,
%                   expansion=quality,
%                   protrusion=quality]

\definefontfallback [noto-fallback] [name:notocoloremoji] [0x00000-0xFFFFF][check=yes,force=no]

\starttypescript [main]
  \definefontsynonym[HelveticaNeue-Regular]    [file:HelveticaNeue]
  \definefontsynonym[HelveticaNeue-Italic]     [file:HelveticaNeueItalic]
  \definefontsynonym[HelveticaNeue-Bold]       [file:HelveticaNeueBold]
\stoptypescript

\starttypescript [light]
  \definefontsynonym[HelveticaNeueLight-Regular]    [file:HelveticaNeueLight]
  \definefontsynonym[HelveticaNeueLight-Italic]     [file:HelveticaNeueLightItalic]
\stoptypescript

\starttypescript [sans] [main]
  \setups[font:fallback:sans]          % security: if not found==> back to defaults
% \definefontsynonym[ConTeXt basics name] [Human readable]       [features=default]
  \definefontsynonym[Sans]                [HelveticaNeue-Regular]    [features=default, fallbacks=noto-fallback]
  \definefontsynonym[SansItalic]          [HelveticaNeue-Italic]     [features=default]
  \definefontsynonym[SansBold]            [HelveticaNeue-Bold]       [features=default]
\stoptypescript

\starttypescript [mono] [jetbrains]
  \setups[font:fallback:mono]          % security: if not found==> back to defaults
% \definefontsynonym[ConTeXt basics name] [Human readable]       [features=default]
  \definefontsynonym[Mono]                [JetBrainsMono-Regular]    [features=default]
  \definefontsynonym[MonoItalic]          [JetBrainsMono-Italic]     [features=default]
  \definefontsynonym[MonoBold]            [JetBrainsMono-Bold]       [features=default]
\stoptypescript

\starttypescript [sans] [light]
  \setups[font:fallback:sans]          % security: if not found==> back to defaults
% \definefontsynonym[ConTeXt basics name] [Human readable]       [features=default]
  \definefontsynonym[Sans]                [HelveticaNeueLight-Regular]    [features=default, fallbacks=noto-fallback]
  \definefontsynonym[SansItalic]          [HelveticaNeueLight-Italic]     [features=default]
\stoptypescript

\starttypescript [main]
  \definetypeface [main]    [ss] [sans] [main]    [default]
\stoptypescript

\starttypescript [light]
  \definetypeface [light]    [ss] [sans] [light]    [default]
  
\stoptypescript
                 
%[tf=helveticaneuethin, it=helveticaneuelightitalic, sl=helveticaneuelightitalic, bf=helveticaneuebold, bi=helveticaneuelightitalic]

%[tf=file:HelveticaNeueLight.ttf, em=file:HelveticaNeueLightItalic.ttf, expansion=quality,protrusion=quality,it=file:HelveticaNeueLightItalic.ttf, sl=file:helveticaneuelightitalic]
\setupbodyfont[main, 11pt]

% helveticalt55roman         helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneue              helveticaneue     helveticaneue              /home/brian/.fonts/HelveticaNeue.ttf
% helveticaneuebold          helveticaneue     helveticaneuebold          /home/brian/.fonts/HelveticaNeue-Bold.ttf
% helveticaneueitalic        helveticaneue     helveticaneueitalic        /home/brian/.fonts/HelveticaNeueItalic.ttf
% helveticaneuelight         helveticaneue     helveticaneuelight         /home/brian/.fonts/HelveticaNeueLight.ttf
% helveticaneuelightitalic   helveticaneue     helveticaneuelightitalic   /home/brian/.fonts/HelveticaNeueLightItalic.ttf
% helveticaneuelt            helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneuelt55roman     helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneueltnormal      helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneueltregular     helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneueltroman       helveticaneuelt   helveticaneueltroman       /home/brian/.fonts/helveticaneue.ttf
% helveticaneuenormal        helveticaneue     helveticaneueitalic        /home/brian/.fonts/HelveticaNeueItalic.ttf
% helveticaneueregular       helveticaneue     helveticaneue              /home/brian/.fonts/HelveticaNeue.ttf
% helveticaneuethin          helveticaneue     helveticaneuethin          /home/brian/.fonts/HelveticaNeue-Thin.ttf
% helveticaneuew0145light                      helveticaneuew0145light    /home/brian/.fonts/helveticaneue-light.ttf

\newdimen\Margin
\Margin=3cm

\newdimen\MarginRaise
\MarginRaise=56ex

\usemodule[database]
% Enable hyperlinks

\setuppapersize [width=190.5mm, height=228.6 mm][width=190.5mm, height=228.6 mm]
\setuplayout    [width=middle,  backspace=30.1625mm, cutspace=30.1625mm, %backspace=38.1 mm, cutspace=22.225 mm,
                 height=middle, topspace=19.05 mm, bottomspace=19.05 mm,
                 topdistance=8.819mm, marking=on]




\setupwhitespace[none]

\define[2]\MyChapterCommand%
  {\vbox{%]
\setupinterlinespace[line=26pt]%  


%\switchtobodyfont[main]%
%\switchtobodyfont[14pt]

\setupalign[flushleft, verytolerant, stretch, hz, hanging]{%
\blank[40mm]{\switchtobodyfont[light]\switchtobodyfont[14pt]#2}%
}}}




\setuphead[section]      [style={\switchtobodyfont[light]\tfc}]
\setuphead[subsection]   [style={\switchtobodyfont[light]\tfb}]
\setuphead[subsubsection][style={\switchtobodyfont[light]\bf}]

\setuphead[chapter, section, subsection, subsubsection][incrementnumber=yes,number=no,align={flushleft, verytolerant}, alternative=inmargin]
\setuphead[chapter]      [header=empty, command=\MyChapterCommand]
\enabletrackers[graphics.locating]

\definedescription
  [description]
  [headstyle=bold, style=normal, location=hanging, width=broad, margin=1cm]

\setupitemize[autointro]    % prevent orphan list intro
\setupitemize[indentnext=no]

\setupfloat[figure][default={here,number}]
\setupfloat[table][default={here,number}]

\setupthinrules[width=15em] % width of horizontal rules

\setupdelimitedtext
  [blockquote]
  [before={\blank[medium]},
   after={\blank[medium]\setupalign[hz, hanging]},
   style={\switchtobodyfont[light]\setupalign[hz, hanging]},
   indentnext=no,
  ]

\setupindenting[yes, 6.35mm]
\setupindenting[first]

\def\hangover{\hangafter=1\hangindent=0.5in}

\definestartstop [workscited] [
  before={%
   \indenting[never]
   \bgroup\appendtoks\hangover\to\everypar
  },
  after={\egroup
    \indenting[yes]},
]

\setupexternalfigures[directory={images, /tmp/images}, maxwidth=\textwidth, maxheight=.9\textheight, scale=3000]

\setupcaption[table][location=top]
\setupcaptions[style={\tfx}, width=.9\textwidth,align=middle]

% ToC
% level=4, \subsubsubsections are not listed in ToC
% alternative=c, space to the page number is filled with dots
\setupcombinedlist[content][list={chapter,section,subsection,subject}]

%\setuplist[chapter][width=5mm, style=bold]
\setuplist[section][margin=10mm]
\setuplist[subsection][margin=20mm]

\setuphead[chapter][prefix=+]
%\setuphead[chapter][referenceprefix=+]

\definecolor[highlight][yellow]
\defineframed
    [important]
    [location=low, frame=off, background=color, backgroundcolor=highlight]

\setupurl
   [style=\tf,
   color=blue]

\startsetups[footnote:align]
  \definefontfamily[footnote][sans][helveticaneue][expansion=quality,protrusion=quality,it=file:helveticaneueitalic, sl=file:helveticaneueitalic]
  \setupbodyfont[footnote, 8pt]  
  \setupalign[hanging, hz, hyphenated, morehyphenation, verytolerant, flushleft]
\stopsetups

\setupnote[footnote][setups=footnote:align]

\setuptolerance   [{verytolerant, stretch}]


\sethyphenatedurlafter{/}
\sethyphenatedurlafter{?}
\sethyphenatedurlafter{-}


\defineseparatedlist[CSV]
  [separator={,},
   quotechar={"},
   left=\bTD,right=\eTD,
   first=\bTR,last=\eTR,
   before=\bTABLE,after=\eTABLE]

\defineseparatedlist[SplitCSVbody]
  [separator={,},
   quotechar={"},
   left=\bTC,right=\eTC,
   first=\bTR,last=\eTR,
   before=\bTABLEbody,after=\eTABLEbody]   

\defineseparatedlist[SplitCSVbodylines]
  [separator={,},
   quotechar={"},
   left=\bTC,right=\eTC,
   first=\bTR,last=\eTR
   before={}, after={}]   

\defineseparatedlist[SplitCSVhead]
  [separator={,},
   quotechar={"},
   left=\bTH,right=\eTH,
   first=\bTR,last=\eTR,
   before=\bTABLEhead,after=\eTABLEhead]     

\setupTABLE[c][each][align=flushleft,style={\tfx}]
\setupTABLE[r][1][background=color,backgroundcolor=gray,style={\tf}]
\setupTABLE[align=middle]
\setuppagenumbering[alternative=singlesided, location={header, margin}, style={\setupbodyfont[9pt]}]

\setuptables
   [split=yes,
    header=text]

\setupheadertexts[]
\setupheader[text][state=normal, style={\setupbodyfont[9pt]}]

\setupheadertexts[\setups{text b}][\setups{text a}][\setups{text a}][\setups{text b}]

\startsetups[text a]
  archipelagos {\it Issue (\getvariable{article}{issue})}~[~\getvariable{article}{date}~]
\stopsetups

\startsetups[text b]
  \[~\getvariable{article}{shortauthor}~\]~\getmarking[chapter]
\stopsetups

%\showframe


\definelayer[firstfooter][repeat=no, state=start,x=30.1625mm,y=272.6mm]%x=28.1mm,y=4.233mm,
\setupbackgrounds[page][background=firstfooter, state=start]

\setlayer[firstfooter]{% ,x=38.1mm, y=209.55mm
\switchtobodyfont[6pt]
archipelagos~\bullet~\getvariable{article}{date}~\bullet~DOI~\getvariable{article}{DOI}~\bullet~CC-BY 4.0 International~\bullet~ISSN: 2689-842X\hfill
}

\definehspace[1][5 mm]
\definehspace[2][1 cm]
\definehspace[3][1.5 cm]
\definehspace[4][2 cm]
\definehspace[5][2.5 cm]
\definehspace[6][3 cm]
\definehspace[7][3.5 cm]
\definehspace[8][4 cm]
\definehspace[9][4.5 cm]

\setupitemize[distance=5mm]


\setupalign[hz,hanging]
\setupinterlinespace[line=14pt]



\unprotect
%\def\hyphenatedurlseparator{↩}
\def\citet{\dosingleempty\doCiteT}
\def\doCiteT[#1]#2{%
  \iffirstargument
    \cite[alternative=authoryear,extras={, #1}][#2]%
  \else
    \cite[alternative=authoryear][#2]%
  \fi
}

\def\citep{\dosingleempty\doCiteP}
\def\doCiteP[#1]#2{%
  \iffirstargument
    \cite[alternative=authoryears,extras={, #1}][#2]%
  \else
    \cite[alternative=authoryears][#2]%
  \fi
}

\define[1]\citeyear{\cite[alternative=year,left={},right={}][#1]}
\define[1]\citeauthor{\cite[alternative=author,left={},right={}][#1]}
\protect

\definebtxdataset
[document]

\stopenvironment

